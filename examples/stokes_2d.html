

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>stokes_2d &mdash; ppiclF  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Examples" href="../examples.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> ppiclF
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">stokes_2d</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-files">User Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-calls">External Calls</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ppiclF</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>stokes_2d</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/examples/stokes_2d.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="stokes-2d">
<span id="stokes2d"></span><h1>stokes_2d<a class="headerlink" href="#stokes-2d" title="Permalink to this headline">¶</a></h1>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>This is a simple example that illustrates Stokes drag on solid spherical particles. This can be illustrated by the following system of equations. For each particle, we have</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}\dfrac{d \mathbf{X}}{d t} &amp;= \mathbf{V}, \\ M_p \dfrac{d \mathbf{V}}{d t} &amp;= \mathbf{F}_{qs} + \mathbf{F}_b, \end{align}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{X} = [X, Y]^T\)</span> is the position of each particle, <span class="math notranslate nohighlight">\(\mathbf{V} = [V_x, V_y]^T\)</span> is the velocity of each particle, <span class="math notranslate nohighlight">\(M_p\)</span> is the mass of each particle, <span class="math notranslate nohighlight">\(\mathbf{F}_{qs} = -3 \pi \mu D_p \mathbf{V}\)</span> is the Stokes drag force on each particle, and <span class="math notranslate nohighlight">\(\mathbf{F}_{b} = [0,-M_p g]^T\)</span> is the weight force on each particle.</p>
<p>Thus, for each particle we can write the following system of equations</p>
<div class="math notranslate nohighlight">
\[\dfrac{d \mathbf{Y}}{d t} = \dot{\mathbf{Y}},\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{Y} = \begin{bmatrix}X \\ Y \\ V_x \\ V_y \end{bmatrix},\quad \dot{\mathbf{Y}} = \begin{bmatrix}V_x \\ V_y \\ -V_x/\tau_p \\ -V_y/\tau_p - g \end{bmatrix},\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\tau_p = 3 \pi \mu D_p / M_p\)</span>.</p>
</div>
<div class="section" id="user-files">
<h2>User Files<a class="headerlink" href="#user-files" title="Permalink to this headline">¶</a></h2>
<p>As is demonstrated above, for each particle we are solving a system of <code class="code docutils literal notranslate"><span class="pre">PPICLF_LRS</span> <span class="pre">=</span> <span class="pre">4</span></code> equations, which is the length of the vectors <span class="math notranslate nohighlight">\(\mathbf{Y}\)</span> and <span class="math notranslate nohighlight">\(\dot{\mathbf{Y}}\)</span>. We will order each equation as they appear in the array above (note that position must always come first when ordering the vector, but the remaining ordering is up to the user). Accordinging we call the solution variables</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PPICLF_JX</span>
<span class="n">PPICLF_JY</span>
<span class="n">PPICLF_JVX</span>
<span class="n">PPICLF_JVY</span>
</pre></div>
</div>
<p>Additionally, we allow <span class="math notranslate nohighlight">\(\tau_p\)</span> to vary for particle, so each particle has <code class="code docutils literal notranslate"><span class="pre">PPICLF_LRP</span> <span class="pre">=</span> <span class="pre">1</span></code> real property associated with it. Accordingly we call the properties</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PPICLF_R_JTAUP</span>
</pre></div>
</div>
<p>For this example then, the ppiclf_user.h header file is</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PPICLF_LRS 4</span>
<span class="cp">#define PPICLF_JX 1</span>
<span class="cp">#define PPICLF_JY 2</span>
<span class="cp">#define PPICLF_JVX 3</span>
<span class="cp">#define PPICLF_JVY 4</span>

<span class="cp">#define PPICLF_LRP 1</span>
<span class="cp">#define PPICLF_R_JTAUP 1</span>
</pre></div>
</div>
<p>Thus, when we access the array ppiclf_y(i,j), the i (max <code class="code docutils literal notranslate"><span class="pre">PPICLF_LRS</span></code>) solution variable (<span class="math notranslate nohighlight">\(\mathbf{Y}\)</span>) for the j particle may be accessed. Similarly, the ppiclf_ydot(i,j) array is the corresponding right side of the system (<span class="math notranslate nohighlight">\(\dot{\mathbf{Y}}\)</span>). The real property array for each particle can be accessed in the code as ppiclf_rprop(k,j) for the k (max <code class="code docutils literal notranslate"><span class="pre">PPICLF_LRP</span></code>) property of the j particle.</p>
<p>The user is required to supply the ppiclf_user.f file. The main purpose of this file is to set <span class="math notranslate nohighlight">\(\dot{\mathbf{Y}}\)</span>. Accordingly, the subroutine <code class="code docutils literal notranslate"><span class="pre">ppiclf_user_SetYdot(time,y,ydot)</span></code> sets <span class="math notranslate nohighlight">\(\dot{\mathbf{Y}}\)</span> and for this case is given as</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">ppiclf_user_SetYdot</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">ydot</span><span class="p">)</span>
<span class="cp">#include &quot;PPICLF&quot;</span>

      <span class="kt">real    </span><span class="nb">time</span>
<span class="nb">      </span><span class="kt">real    </span><span class="n">y</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="kt">real    </span><span class="n">ydot</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>

<span class="n">c</span> <span class="n">evaluate</span> <span class="n">ydot</span>
      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ppiclf_npart</span>
         <span class="c">! striding solution y vector</span>
         <span class="n">j</span> <span class="o">=</span> <span class="n">PPICLF_LRS</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

         <span class="c">! Stokes drag</span>
         <span class="n">fqsx</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">(</span><span class="n">PPICLF_JVX</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">ppiclf_rprop</span><span class="p">(</span><span class="n">PPICLF_R_JTAUP</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
         <span class="n">fqsy</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">(</span><span class="n">PPICLF_JVY</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">ppiclf_rprop</span><span class="p">(</span><span class="n">PPICLF_R_JTAUP</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

         <span class="c">! Gravity</span>
         <span class="n">fbx</span>  <span class="o">=</span> <span class="mf">0.0</span>
         <span class="n">fby</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">9.8</span>

         <span class="c">! set ydot for all PPICLF_LRS number of equations</span>
         <span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JX</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">PPICLF_JVX</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span>
         <span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JY</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">PPICLF_JVY</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span>
         <span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JVX</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">fqsx</span><span class="o">+</span><span class="n">fbx</span>
         <span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JVY</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">fqsy</span><span class="o">+</span><span class="n">fby</span>
      <span class="n">enddo</span>
<span class="n">c</span> <span class="n">evaluate</span> <span class="n">ydot</span>

      <span class="k">return</span>
<span class="k">      end</span>
</pre></div>
</div>
<p>In this example, the do-loop loops through the total number of particles on each processor, which is <code class="code docutils literal notranslate"><span class="pre">ppiclf_npart</span></code>. There are three input arguments to this routine, which are the current time (<code class="code docutils literal notranslate"><span class="pre">time</span></code>), a pointer to the first location of the array ppiclf_y(:,:) (<code class="code docutils literal notranslate"><span class="pre">y(*)</span></code>), and a pointer to the first location of the array ppiclf_ydot(:,:) (<code class="code docutils literal notranslate"><span class="pre">ydot(*)</span></code>).</p>
<p>It is the users responsibility to set <code class="code docutils literal notranslate"><span class="pre">ydot(*)</span></code> for each particle, which corresponds to <span class="math notranslate nohighlight">\(\dot{\textbf{Y}}\)</span>. At the end of the loop in this example, this is done by</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JX</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">PPICLF_JVX</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span>
<span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JY</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">PPICLF_JVY</span> <span class="o">+</span><span class="n">j</span><span class="p">)</span>
<span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JVX</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">fqsx</span><span class="o">+</span><span class="n">fbx</span>
<span class="n">ydot</span><span class="p">(</span><span class="n">PPICLF_JVY</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">fqsy</span><span class="o">+</span><span class="n">fby</span>
</pre></div>
</div>
<p>Note that within the loop, the striding variable <code class="code docutils literal notranslate"><span class="pre">j</span></code> is used to access the <code class="code docutils literal notranslate"><span class="pre">i</span></code> particles properties in the pointer arrays <code class="code docutils literal notranslate"><span class="pre">y(*)</span></code> and <code class="code docutils literal notranslate"><span class="pre">ydot(*)</span></code>. This equation corresponds to the system described above where fqsx and fqsy are the directional drag components as a function of <span class="math notranslate nohighlight">\(\tau_p\)</span> and fbx and fby are the directional weight components.</p>
<p>Note that two additional subroutines are also declared in this file, which are <code class="code docutils literal notranslate"><span class="pre">ppiclf_user_MapProjPart(map,y,ydot,ydotc,rprop)</span></code> and <code class="code docutils literal notranslate"><span class="pre">ppiclf_user_EvalNearestNeighbor(i,j,yi,rpropi,yj,rpropj)</span></code>. In this example these routines are not used so their contents are blank. However, they must still be decleared.</p>
<p>The two user files (ppiclf_user.f and ppiclf_user.h) are then copied to the source/ directory and the library can be built using make.</p>
</div>
<div class="section" id="external-calls">
<h2>External Calls<a class="headerlink" href="#external-calls" title="Permalink to this headline">¶</a></h2>
<p>In order to solve the system of equations, a driver program is used. In this case, a simple MPI program in the example file test.f is used for this purpose, but these calls may be from an external program that has been linked to the static library which was built in the last step. Specifically, the driver program is responsible for setting the initial conditions of the solution variables <span class="math notranslate nohighlight">\(\mathbf{Y}_0 = \mathbf{Y} (t = 0)\)</span>, specifying solver options, and looping through time steps. Thus, the program in test.f is given and explained below.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>      <span class="k">program </span><span class="n">test</span>
<span class="cp">#include &quot;PPICLF&quot;</span>
      <span class="k">include</span> <span class="s1">&#39;mpif.h&#39;</span>

      <span class="k">call </span><span class="n">MPI_INIT</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
      <span class="n">icomm</span> <span class="o">=</span> <span class="n">MPI_COMM_WORLD</span>
      <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">ppiclf_comm</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
      <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">ppiclf_comm</span><span class="p">,</span> <span class="n">np</span> <span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

      <span class="k">call </span><span class="n">ppiclf_comm_InitMPI</span><span class="p">(</span><span class="n">icomm</span><span class="p">,</span><span class="n">nid</span><span class="p">,</span><span class="n">np</span><span class="p">)</span>
         <span class="k">call </span><span class="n">PlaceParticle</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span><span class="n">ppiclf_y</span><span class="p">)</span>
      <span class="k">call </span><span class="n">ppiclf_solve_InitParticle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">npart</span><span class="p">,</span><span class="n">ppiclf_y</span><span class="p">)</span>

      <span class="c">! time loop</span>
      <span class="n">iostep</span> <span class="o">=</span> <span class="mf">1E2</span>
      <span class="n">nstep</span>  <span class="o">=</span> <span class="mf">1E4</span>
      <span class="n">dt</span>     <span class="o">=</span> <span class="mf">1E-4</span>
      <span class="k">do </span><span class="n">istep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstep</span>
         <span class="nb">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">istep</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span>
         <span class="k">call </span><span class="n">ppiclf_solve_IntegrateParticle</span><span class="p">(</span><span class="n">istep</span><span class="p">,</span><span class="n">iostep</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="nb">time</span>
     <span class="o">&gt;</span>                                      <span class="p">,</span><span class="n">ppiclf_y</span><span class="p">,</span><span class="n">ppiclf_ydot</span><span class="p">)</span>
      <span class="n">enddo</span>

      <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>

      <span class="k">stop</span>
<span class="k">      end</span>
</pre></div>
</div>
<p>First, MPI is initialized using the current communicator <code class="code docutils literal notranslate"><span class="pre">icomm</span></code>, the current MPI rank <code class="code docutils literal notranslate"><span class="pre">nid</span></code>, and the total number of processors <code class="code docutils literal notranslate"><span class="pre">np</span></code>. These are passed to the routine <code class="code docutils literal notranslate"><span class="pre">ppiclf_comm_InitMPI(icomm,nid,np)</span></code>.</p>
<p>Following this, the user initializes the initial conditions <span class="math notranslate nohighlight">\(\mathbf{Y}_0\)</span> for <code class="code docutils literal notranslate"><span class="pre">npart</span></code> local particles and the local properties (only property <span class="math notranslate nohighlight">\(\tau_p\)</span>) for each particle in the local subroutine <code class="code docutils literal notranslate"><span class="pre">PlaceParticle(npart,ppiclf_y)</span></code>. These are then passed to the subroutine <code class="code docutils literal notranslate"><span class="pre">ppiclf_solve_InitParticle(imethod,ndim,iendian,npart,ppiclf_y)</span></code>. The inputs to this routine are imethod (the time integration method), ndim (the dimensionality of the problem, iendian (byte swapping on system), and the number and initial condition of particles (npart and ppiclf_y).</p>
<p>Following this, a dummy time loop is iterated with the subroutine <code class="code docutils literal notranslate"><span class="pre">ppiclf_solve_IntegrateParticle(istep,iostep,dt,time,ppiclf_y,ppiclf_ydot)</span></code> called at each time step. This routine will advance the system of equations in time, with istep being the current time step, output of the solution every iostep, with a time step of dt, at a current time of time. Additionally, the current system solution array ppiclf_y and to-be-set right side of the system ppiclf_ydot are also passed in.</p>
<p>The makefile includes an example of linking the static library to test.f file in compilation. This case can be built and run on &lt;#&gt; processors using your systems MPI compiler. For example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make
mpirun -np &lt;<span class="c1">#&gt; test.out</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, David Zwick

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>