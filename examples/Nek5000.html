

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Nek5000 Case &mdash; ppiclF Documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://dpzwick.github.io/ppiclF-doc/examples/Nek5000.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing" href="../contribute.html" />
    <link rel="prev" title="DEM Packing 3D" href="dem_pack_3d.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> ppiclF
          

          
            
            <img src="../_static/ppiclF.gif" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.html">Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user.html">User Interface</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="stokes_2d.html">Stokes 2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="dem_pack_3d.html">DEM Packing 3D</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Nek5000 Case</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-interface">User Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compiling-and-running">Compiling and Running</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../acknowledge.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ppiclF</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Nek5000 Case</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nek5000-example">
<span id="id1"></span><h1><a class="reference external" href="https://github.com/dpzwick/ppiclF/tree/master/examples/Nek5000">Nek5000 Case</a><a class="headerlink" href="#nek5000-example" title="Permalink to this headline">¶</a></h1>
<div style="position: relative; padding-bottom: 10.00%; height: 0; overflow: hidden; max-width: 100%; height: auto;">
   <iframe width="560" height="315" src="https://www.youtube.com/embed/xaH7ub68S7k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div><div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>This is an example that illustrates a two-dimensional fluidized bed. This example also illustrates linking ppiclF to the incompressible, spectral element, fluid solver <a class="reference external" href="https://nek5000.mcs.anl.gov">Nek5000</a>.</p>
<p>The core particle equations being solved in this case are</p>
<div class="math notranslate nohighlight">
\[\begin{split}\dfrac{d \mathbf{X}}{d t} &amp;= \mathbf{V}, \\ M_p \dfrac{d \mathbf{V}}{d t} &amp;= \mathbf{F}_{qs} + \mathbf{F}_{c} + \mathbf{F}_b,\end{split}\]</div>
<p>where, for each particle we have the position vector <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>, the velocity vector <span class="math notranslate nohighlight">\(\mathbf{V}\)</span>, the drag force <span class="math notranslate nohighlight">\(\mathbf{F}_{qs}\)</span>, the collision force <span class="math notranslate nohighlight">\(\mathbf{F}_{c}\)</span>, and the weight force <span class="math notranslate nohighlight">\(\mathbf{F}_{b}\)</span>, defined by</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{X} = \begin{bmatrix}X \\ Y \end{bmatrix},\quad \mathbf{V} = \begin{bmatrix}V_x \\ V_y \end{bmatrix},\end{split}\]</div>
<p>and the same weight and collision forces as in the <a class="reference internal" href="dem_pack_3d.html#dem3d"><span class="std std-ref">DEM Packing 3D</span></a> example are used. For the drag force, the Gidaspow drag model has been used, which is</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{F}_{qs} = \beta V_p (\mathbf{U} - \mathbf{V}) = \beta V_p \begin{bmatrix} U_x - V_x \\ U_y - V_y \end{bmatrix},\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{U}\)</span> is the fluid velocity vector interpolated to the particle’s coordinates, <span class="math notranslate nohighlight">\(V_p\)</span> is each particle’s volume, and <span class="math notranslate nohighlight">\(\beta\)</span> is a drag coefficient, computed by</p>
<div class="math notranslate nohighlight">
\[\begin{split}\beta = \begin{cases}150 \dfrac{\phi_p}{\phi_f} \dfrac{\mu_f}{D_p^2} + 1.75 \dfrac{\rho_f}{D_p} |\mathbf{U} - \mathbf{V}| &amp; \phi_p &gt; 0.2, \\ 0.75 C^*_D \dfrac{\phi_f}{D_p} \rho_f |\mathbf{U} - \mathbf{V}| \phi_f^{-2.65} &amp; \phi_p \leq 0.2. \end{cases}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(C^*_D\)</span> is another drag coefficient, <span class="math notranslate nohighlight">\(Re_p^* = \phi_f |\mathbf{U}-\mathbf{V}|D_p/ \nu_f\)</span> is the volume weighted Reynolds number, and <span class="math notranslate nohighlight">\(\nu_f = \mu_f/\rho_f\)</span> is the fluid kinematic viscosity. The equation for <span class="math notranslate nohighlight">\(C^*_D\)</span> is</p>
<div class="math notranslate nohighlight">
\[\begin{split}C^*_D = \begin{cases} \dfrac{24}{Re_p^*} \left( 1 + 0.15 (Re_p^*)^{0.687} \right) &amp; Re_p^* \leq 10^3, \\ 0.44 &amp; Re_p^* &gt; 10^3 . \end{cases}\end{split}\]</div>
<p>The fluid equations that Nek5000 solves in this example are</p>
<div class="math notranslate nohighlight">
\[\begin{split}\nabla \cdot \mathbf{u} &amp;= - \dfrac{1}{\phi_f} \dfrac{D \phi_f}{D t}, \\ \rho_f \dfrac{D \mathbf{u}}{D t} &amp;= \nabla \cdot \mathbf{\sigma}_f + \dfrac{\mathbf{f}_{pf}}{\phi_f},\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> is the fluid velocity, <span class="math notranslate nohighlight">\(\rho_f\)</span> is the fluid density, <span class="math notranslate nohighlight">\(\mathbf{\sigma}_f\)</span> is the Navier-Stokes fluid stress tensor, <span class="math notranslate nohighlight">\(\phi_f\)</span> is the fluid volume fraction, and <span class="math notranslate nohighlight">\(\phi_p\)</span> is the particle volume fraction (<span class="math notranslate nohighlight">\(\phi_f + \phi_p = 1\)</span>), and <span class="math notranslate nohighlight">\(\mathbf{f}_{pf}\)</span> is a particle-fluid coupling force.</p>
<p>The solution to these equations reside on a mesh within Nek5000. Since the particles are solved in the Lagrangian reference frame, their contributions on the mesh must be accounted for. Most notably, the explicit particle contributions from ppiclF to Nek5000 are <span class="math notranslate nohighlight">\(\phi_p\)</span> (and as a result <span class="math notranslate nohighlight">\(\phi_f\)</span>) and <span class="math notranslate nohighlight">\(\mathbf{f}_{pf}\)</span>. The method by which these fields are obtained is <a class="reference internal" href="../algorithms/overlap_mesh.html#projection"><span class="std std-ref">Projection</span></a>.</p>
</div>
<div class="section" id="user-interface">
<h2>User Interface<a class="headerlink" href="#user-interface" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../user/hfile.html#hfile"><span class="std std-ref">The H-File</span></a> for this case (<a class="reference external" href="https://github.com/dpzwick/ppiclf/tree/master/examples/Nek5000/user_routines/PPICLF_USER.h">Nek5000 H-File</a>) is given below and corresponds to the equations being solved and the property being stored for each particle. Note that since <span class="math notranslate nohighlight">\(g\)</span> is constant, we do not included in in the list of properties.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PPICLF_LRS 4</span>
<span class="cp">#define PPICLF_LRP 6</span>
<span class="cp">#define PPICLF_LEE 1000</span>
<span class="cp">#define PPICLF_LEX 6</span>
<span class="cp">#define PPICLF_LEY 6</span>
<span class="cp">#define PPICLF_LRP_INT 3</span>
<span class="cp">#define PPICLF_LRP_PRO 3</span>

<span class="cp">#define PPICLF_JX 1</span>
<span class="cp">#define PPICLF_JY 2</span>
<span class="cp">#define PPICLF_JVX 3</span>
<span class="cp">#define PPICLF_JVY 4</span>
<span class="cp">#define PPICLF_R_JRHOP 1</span>
<span class="cp">#define PPICLF_R_JDP 2</span>
<span class="cp">#define PPICLF_R_JVOLP 3</span>
<span class="cp">#define PPICLF_R_JPHIP 4</span>
<span class="cp">#define PPICLF_R_JUX 5</span>
<span class="cp">#define PPICLF_R_JUY 6</span>
<span class="cp">#define PPICLF_P_JPHIP 1</span>
<span class="cp">#define PPICLF_P_JFX 2</span>
<span class="cp">#define PPICLF_P_JFY 3</span>
</pre></div>
</div>
<p>The two blocks of lines denote the pre-defined and user-only directives. The pre-defined directives are in the top block and are the number of equations, the number of properties, the sizes of the overlap mesh, the number of interpolated fields, and the number of projected fields. The user-only directives are in the bottom block.</p>
<p><a class="reference internal" href="../user/ffile.html#ffile"><span class="std std-ref">The F-File</span></a> for this case (<a class="reference external" href="https://github.com/dpzwick/ppiclf/tree/master/examples/Nek5000/user_routines/ppiclf_user.f">Nek5000 F-File</a>) has meaningful information in every routine. The routine ppiclf_user_SetYdot is nearly the same as the <a class="reference internal" href="dem_pack_3d.html#dem3d"><span class="std std-ref">DEM Packing 3D</span></a> example but with an added drag model evaluation that is slightly more complicated than the <a class="reference internal" href="stokes_2d.html#stokes2d"><span class="std std-ref">Stokes 2D</span></a> example. Also, the ppiclf_user_EvalNearestNeighbor routine is similar to the <a class="reference internal" href="dem_pack_3d.html#dem3d"><span class="std std-ref">DEM Packing 3D</span></a> example. The new addition is the mapping of particle properties to be projected in ppiclf_user_MapProjPart. With some study, it can be found that the three fields being projected in 2D are:</p>
<table class="docutils align-center" id="id2">
<caption><span class="caption-text">Projection mapping in ppiclf_user_MapProjPart.</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 52%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Projected Field (<span class="math notranslate nohighlight">\(a(\mathbf{x})\)</span>)</p></th>
<th class="head"><p>Particle Property (<span class="math notranslate nohighlight">\(A^{(i)}\)</span>)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\phi_p(\mathbf{x})\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(V_p/D_p\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(f_{pf,x}(\mathbf{x})\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-F_{qs,x}/D_p\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(f_{pf,y}(\mathbf{x})\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-F_{qs,y}/D_p\)</span></p></td>
</tr>
</tbody>
</table>
<p>where <span class="math notranslate nohighlight">\(D_p\)</span> has been used to normalize the values in 2D. Note that the negative signs of the components of <span class="math notranslate nohighlight">\(\mathbf{F}_{qs}\)</span> were added when the forces were stored in the storage array ppiclf_ydotc at the end of the routine ppiclf_user_SetYdot.</p>
<p>The <a class="reference internal" href="../user/external.html#external"><span class="std std-ref">External Interface</span></a> calls for this example occur within the user initialization Nek5000 routine usrdat2 in the file <a class="reference external" href="https://github.com/dpzwick/ppiclf/tree/master/examples/Nek5000/uniform.usr">uniform.usr</a> with the minimum number of initialization and solve subroutines called. In this case:</p>
<ul class="simple">
<li><p>ppiclf_comm_InitMPI is called to initialize the communication,</p></li>
<li><p>ppiclf_comm_InitParticle is called with initial properites and conditions for the particles,</p></li>
<li><p>ppiclf_solve_InitGaussianFilter is called to initialize the fitler for projection to the overlap mesh,</p></li>
<li><p>ppiclf_comm_InitOverlapMesh is called to initialize the overlap mesh from Nek5000,</p></li>
<li><p>ppiclf_solve_InitNeighborBin is called with minimum interaction distance of the largest particle size,</p></li>
<li><p>ppiclf_solve_InitWall is called which sets a wall for the particles at the bottom of the domain,</p></li>
<li><p>ppiclf_solve_InitPeriodicX is called which sets periodicity in the x dimension along the domain.</p></li>
</ul>
<p>Additionally, the solve routines are called every time step in the same file in various Nek5000 user routines. In this example,</p>
<ul class="simple">
<li><p>ppiclf_solve_InterpFieldUser is called three times to interpolate the fields <span class="math notranslate nohighlight">\(\phi_p\)</span>, <span class="math notranslate nohighlight">\(u_x\)</span>, and <span class="math notranslate nohighlight">\(u_y\)</span> into the property array,</p></li>
<li><p>ppiclf_solve_IntegrateParticle is called to integrate the system at the current time step,</p></li>
<li><p>ppiclf_solve_GetProFldIJKEF is called to access the projected fields and use them locally in Nek5000 (force coupling and volume fraction effects).</p></li>
</ul>
<p>Also, note that ppiclF has been linked with Nek5000 in the Nek5000 makenek compilation file through the following lines:</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="nv">SOURCE_ROOT_PPICLF</span><span class="o">=</span><span class="nv">$HOME</span>/libraries/ppiclF/source
<span class="nv">FFLAGS</span><span class="o">=</span><span class="s2">&quot; -I</span><span class="nv">$SOURCE_ROOT_PPICLF</span><span class="s2">&quot;</span>
<span class="nv">USR_LFLAGS</span><span class="o">+=</span><span class="s2">&quot; -L</span><span class="nv">$SOURCE_ROOT_PPICLF</span><span class="s2"> -lppiclF&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="compiling-and-running">
<h2>Compiling and Running<a class="headerlink" href="#compiling-and-running" title="Permalink to this headline">¶</a></h2>
<p>This example can be tested with Nek5000 by issuing the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~
git clone https://github.com/dpzwick/ppiclF.git            <span class="c1"># clone ppiclF</span>
git clone https://github.com/Nek5000/Nek5000.git           <span class="c1"># clone Nek5000</span>
mkdir TestCase                                             <span class="c1"># make test directory</span>
<span class="nb">cd</span> TestCase
cp -r ../ppiclF/examples/Nek5000/* .                       <span class="c1"># copy example files to test case</span>
<span class="nb">cd</span> ../ppiclF                                               <span class="c1"># go to ppiclF code</span>
cp ../TestCase/user_routines/* source/                     <span class="c1"># copy ppiclf_user.f and PPICLF_USER.h to source</span>
make                                                       <span class="c1"># build ppiclF</span>
<span class="nb">cd</span> ../TestCase
./makenek uniform                                          <span class="c1"># build Nek5000 and link with ppiclF</span>
<span class="nb">echo</span> uniform &gt; SESSION.NAME <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/ &gt;&gt; SESSION.NAME <span class="c1"># create Nek5000 necessary file</span>
mpirun -np <span class="m">4</span> nek5000                                       <span class="c1"># run case with 4 processors</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, D. Zwick

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>